name: Build Windows App

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Fix file encodings
      shell: pwsh
      run: |
        # 读取并重新保存文件为UTF-8
        $content = Get-Content requirements.txt -Raw
        [System.IO.File]::WriteAllText("requirements.txt", $content, [System.Text.Encoding]::UTF8)

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 直接安装依赖，不使用requirements.txt
        pip install pandas==1.3.5 numpy==1.21.6 openpyxl==3.1.2
        pip install python-Levenshtein==0.21.1 pillow pyinstaller
        pip install aiohttp==3.8.5 beautifulsoup4==4.12.2 requests==2.31.0
        pip install jellyfish==1.0.1 unittest2>=1.1.0

    - name: Create template and icon
      shell: pwsh
      run: |
        # 确保目录存在
        mkdir templates -ErrorAction SilentlyContinue
        # 设置编码
        $env:PYTHONIOENCODING = "utf-8"
        # 创建模板和图标
        python create_template.py
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        python create_icon.py
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Build with PyInstaller
      shell: pwsh
      run: |
        # 修改spec文件中的name
        $content = Get-Content build_win.spec -Raw
        $content = $content -replace "name='关税查询工具'", "name='英国海关编码税率查询工具'"
        [System.IO.File]::WriteAllText("build_win.spec", $content, [System.Text.Encoding]::UTF8)
        # 运行PyInstaller
        pyinstaller build_win.spec

    # 总是上传构建产物
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v3
      with:
        name: build-artifact
        path: dist/英国海关编码税率查询工具
        retention-days: 5

    - name: Check Build Type
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -like 'refs/tags/*') {
            echo "Building release for tag: $env:GITHUB_REF"
        } else {
            echo "Building for branch: $env:GITHUB_REF"
            echo "To create a release, please create a tag starting with 'v' (e.g., v1.0.0)"
        }

    - name: Create release ZIP
      if: startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        echo "Creating release files for tag: $env:GITHUB_REF"
        cd dist
        7z a -tzip "../英国海关编码税率查询工具-${{ github.ref_name }}.zip" "英国海关编码税率查询工具"
        cd ..
        copy "dist\英国海关编码税率查询工具\英国海关编码税率查询工具.exe" "英国海关编码税率查询工具-${{ github.ref_name }}.exe"
        echo "Release files created successfully"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          英国海关编码税率查询工具-${{ github.ref_name }}.zip
          英国海关编码税率查询工具-${{ github.ref_name }}.exe
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}